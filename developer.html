<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.4">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OACensus Developer Documentation</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style>
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css">
<style>
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #ffffff; }
.highlight .tok-c { color: #888888 } /* Comment */
.highlight .tok-err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .tok-k { color: #008800; font-weight: bold } /* Keyword */
.highlight .tok-cm { color: #888888 } /* Comment.Multiline */
.highlight .tok-cp { color: #cc0000; font-weight: bold } /* Comment.Preproc */
.highlight .tok-c1 { color: #888888 } /* Comment.Single */
.highlight .tok-cs { color: #cc0000; font-weight: bold; background-color: #fff0f0 } /* Comment.Special */
.highlight .tok-gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .tok-ge { font-style: italic } /* Generic.Emph */
.highlight .tok-gr { color: #aa0000 } /* Generic.Error */
.highlight .tok-gh { color: #333333 } /* Generic.Heading */
.highlight .tok-gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .tok-go { color: #888888 } /* Generic.Output */
.highlight .tok-gp { color: #555555 } /* Generic.Prompt */
.highlight .tok-gs { font-weight: bold } /* Generic.Strong */
.highlight .tok-gu { color: #666666 } /* Generic.Subheading */
.highlight .tok-gt { color: #aa0000 } /* Generic.Traceback */
.highlight .tok-kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .tok-kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .tok-kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .tok-kp { color: #008800 } /* Keyword.Pseudo */
.highlight .tok-kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .tok-kt { color: #888888; font-weight: bold } /* Keyword.Type */
.highlight .tok-m { color: #0000DD; font-weight: bold } /* Literal.Number */
.highlight .tok-s { color: #dd2200; background-color: #fff0f0 } /* Literal.String */
.highlight .tok-na { color: #336699 } /* Name.Attribute */
.highlight .tok-nb { color: #003388 } /* Name.Builtin */
.highlight .tok-nc { color: #bb0066; font-weight: bold } /* Name.Class */
.highlight .tok-no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .tok-nd { color: #555555 } /* Name.Decorator */
.highlight .tok-ne { color: #bb0066; font-weight: bold } /* Name.Exception */
.highlight .tok-nf { color: #0066bb; font-weight: bold } /* Name.Function */
.highlight .tok-nl { color: #336699; font-style: italic } /* Name.Label */
.highlight .tok-nn { color: #bb0066; font-weight: bold } /* Name.Namespace */
.highlight .tok-py { color: #336699; font-weight: bold } /* Name.Property */
.highlight .tok-nt { color: #bb0066; font-weight: bold } /* Name.Tag */
.highlight .tok-nv { color: #336699 } /* Name.Variable */
.highlight .tok-ow { color: #008800 } /* Operator.Word */
.highlight .tok-w { color: #bbbbbb } /* Text.Whitespace */
.highlight .tok-mf { color: #0000DD; font-weight: bold } /* Literal.Number.Float */
.highlight .tok-mh { color: #0000DD; font-weight: bold } /* Literal.Number.Hex */
.highlight .tok-mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .tok-mo { color: #0000DD; font-weight: bold } /* Literal.Number.Oct */
.highlight .tok-sb { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .tok-sc { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Char */
.highlight .tok-sd { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Doc */
.highlight .tok-s2 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Double */
.highlight .tok-se { color: #0044dd; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .tok-sh { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .tok-si { color: #3333bb; background-color: #fff0f0 } /* Literal.String.Interpol */
.highlight .tok-sx { color: #22bb22; background-color: #f0fff0 } /* Literal.String.Other */
.highlight .tok-sr { color: #008800; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .tok-s1 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Single */
.highlight .tok-ss { color: #aa6600; background-color: #fff0f0 } /* Literal.String.Symbol */
.highlight .tok-bp { color: #003388 } /* Name.Builtin.Pseudo */
.highlight .tok-vc { color: #336699 } /* Name.Variable.Class */
.highlight .tok-vg { color: #dd7700 } /* Name.Variable.Global */
.highlight .tok-vi { color: #3333bb } /* Name.Variable.Instance */
.highlight .tok-il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>OACensus Developer Documentation</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_development_environment">Development Environment</a></li>
<li><a href="#_running_tests">Running Tests</a></li>
<li><a href="#_database_models">Database Models</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_modelbase">ModelBase</a></li>
<li><a href="#_article">Article</a></li>
<li><a href="#_repository">Repository</a></li>
<li><a href="#_instance">Instance</a></li>
<li><a href="#_journal">Journal</a></li>
<li><a href="#_rating">Rating</a></li>
<li><a href="#_publisher">Publisher</a></li>
<li><a href="#_license">License</a></li>
<li><a href="#_lists">Lists</a></li>
</ul>
</li>
<li><a href="#_is_it_open_access">Is It Open Access?</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_is_it_free_to_read">Is it Free to Read?</a></li>
<li><a href="#_is_it_openly_licensed">Is it openly licensed?</a></li>
</ul>
</li>
<li><a href="#_scraping_workflow">Scraping Workflow</a></li>
<li><a href="#_implementing_scrapers_and_reports">Implementing Scrapers and Reports</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_plugins">Plugins</a></li>
<li><a href="#_scraping">Scraping</a></li>
<li><a href="#_parsing">Parsing</a></li>
<li><a href="#_reporting">Reporting</a></li>
<li><a href="#_running">Running</a></li>
</ul>
</li>
<li><a href="#_scraper_classes">Scraper Classes</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_journalscraper">JournalScraper</a></li>
<li><a href="#_articlescraper">ArticleScraper</a></li>
</ul>
</li>
<li><a href="#_implemented_scrapers">Implemented Scrapers</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_biomed_central">BioMed Central</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#_scraping_2">Scraping</a></li>
<li><a href="#_parsing_2">Parsing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is developer documentation for OACensus.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="icon-check-empty"></i> Finish writing introduction or remove this section.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_environment">Development Environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The easiest way to create a development environment for OACensus is to use
<a href="http://docker.io">Docker</a>. If you can&#8217;t use Docker, then you can use the
Dockerfile script as a guide for what software should be installed.
<a href="http://blog.ananelson.com/2014/03/docker-isolated-and-reproducible/">This blog post</a>
contains some background information as to how Docker is being used.</p>
</div>
<div class="paragraph">
<p>The <code>docker/run-docker.sh</code> script builds and launches two Docker images.</p>
</div>
<div class="paragraph">
<p>The first image creates a (semi-)persistent cache which we&#8217;ll use to store
downloaded files as we run OACensus. By making this a separate volume, it&#8217;s
easy to preserve the cache even if we need to destroy and recreate the
container we are working in. This part of the script builds the new container
and, if it isn&#8217;t already active, it mounts it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">docker build -t oacensus/cache - &lt; Dockerfile-cache
docker ps -a <span class="tok-p">|</span> grep OACENSUSCACHE <span class="tok-o">||</span> <span class="tok-se">\</span>
    docker run --name<span class="tok-o">=</span>OACENSUSCACHE oacensus/cache
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Dockerfile for the cache doesn&#8217;t need to do much, it just needs to specify
a lightweight base image and define where to mount volumes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM busybox
VOLUME /home/oacensus/.oacensus
</pre>
</div>
</div>
<div class="paragraph">
<p>The next part of the script builds and then runs the container we will work in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">docker build -t oacensus/development . <span class="tok-o">&amp;&amp;</span> <span class="tok-se">\</span>
    docker run -t -i <span class="tok-se">\</span>
    --volumes-from<span class="tok-o">=</span>OACENSUSCACHE <span class="tok-se">\</span>
    -v <span class="tok-nv">$OACENSUS_DIR</span>:/home/oacensus/oacensus <span class="tok-se">\</span>
    oacensus/development /bin/bash
</code></pre>
</div>
</div>
<div class="paragraph">
<p>It mounts the persistent cache volume we just created, and it also mounts your
local working checkout of the oacensus repository. You&#8217;ll need to specify the
location in the script, the default value is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash"><span class="tok-nv">OACENSUS_DIR</span><span class="tok-o">=</span>~/dev/oacensus
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, please refer to
<a href="http://blog.ananelson.com/2014/03/docker-isolated-and-reproducible/">this blog post</a>
to understand why this configuration was chosen. Feel free to set up whatever
configuration works best for you, this is just one way to do it.</p>
</div>
<div class="paragraph">
<p>The Dockerfile begins by defining the base image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">FROM       ubuntu:13.10
MAINTAINER Ana Nelson &lt;ana@ananelson.com&gt;
</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to do some tweaking of the locale so Unicode will work correctly (this
is because the Docker base image we are using is so minimal, usually your
Desktop operating system will already be configured):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN locale-gen en_US.UTF-8
ENV LANG en_US.UTF-8
</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it faster to install software repeatedly, you can set up
<code>squid-deb-proxy</code> and this will use previously downloaded installers where
available. This must already be running on your host system, and this line in
the Dockerfile configures the container to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash"><span class="tok-c"># Use squid deb proxy to cache ubuntu installs as per</span>
<span class="tok-c"># https://gist.github.com/dergachev/8441335</span>
<span class="tok-c"># Comment this out if squid-deb-proxy not configured on host.</span>
RUN /sbin/ip route <span class="tok-p">|</span> awk <span class="tok-s1">&#39;/default/ { print &quot;Acquire::http::Proxy \&quot;http://&quot;$3&quot;:8000\&quot;;&quot; }&#39;</span> &gt; /etc/apt/apt.conf.d/30proxy
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure package descriptions are up to date, and install some basic packaging
tools to help with later installs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get update
RUN apt-get install -y software-properties-common
RUN apt-get install -y build-essential
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install some utilities which will be useful to have when working on the container later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get install -y sudo
RUN apt-get install -y vim
RUN apt-get install -y ack-grep
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install some libraries which will help later installs go more smoothly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get install -y zlib1g-dev
RUN apt-get install -y libffi-dev
RUN apt-get install -y libssl-dev
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install Python and pip for package management:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get install -y python-dev
RUN apt-get install -y python-pip
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install dependencies for the lxml package, and then install lxml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get install -y libxml2-dev
RUN apt-get install -y libxslt1-dev
RUN pip install cython

RUN pip install lxml
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install scipy, numpy and matplotlib for reporting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get install -y python-scipy
RUN apt-get install -y python-numpy
RUN apt-get install -y python-matplotlib
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install nose for running tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN pip install nose
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install Ruby and asciidoctor for compiling documentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN apt-get install -y ruby2.0-dev
RUN apt-get install -y ruby2.0
RUN gem install asciidoctor
RUN gem install pygments.rb
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install dexy for automating documentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN pip install dexy
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new system user named <code>oacensus</code>, and set a password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">RUN useradd -m -p <span class="tok-k">$(</span>perl -e<span class="tok-s1">&#39;print crypt(&quot;foobarbaz&quot;, &quot;aa&quot;)&#39;</span><span class="tok-k">)</span> oacensus
RUN adduser oacensus sudo
</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need to use this password when you have to <code>sudo</code> commands within the running container.</p>
</div>
<div class="paragraph">
<p>Finally, we instruct Docker to switch to the new user and ensure the <code>HOME</code> variable is set correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">USER oacensus
ENV HOME /home/oacensus
</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>run-docker.sh</code> script finishes, you should be in the running container.</p>
</div>
<div class="paragraph">
<p>The first time you run the container after building it, you will need to fix home directory permissions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">sudo chown -R oacensus ~
</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll want to install the oacensus package using pip:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash"><span class="tok-nb">cd</span> ~/oacensus
sudo pip install -e .
</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_tests">Running Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s recommended to run tests via the <code>run-tests.sh</code> script which ensures that tests
are run both with and without a cache present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash"><span class="tok-nb">set</span> -e

<span class="tok-nv">CACHE_DIR</span><span class="tok-o">=</span><span class="tok-s2">&quot;.oacensus&quot;</span>

<span class="tok-nb">echo</span> <span class="tok-s2">&quot;Removing cache at $CACHE_DIR&quot;</span>
rm -rf <span class="tok-nv">$CACHE_DIR</span>

<span class="tok-nb">echo</span> <span class="tok-s2">&quot;Running tests with no cache...&quot;</span>
nosetests

<span class="tok-nb">echo</span> <span class="tok-s2">&quot;Running tests with cache...&quot;</span>
nosetests
</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_models">Database Models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we introduce the different database classes, how they relate to
one another, and how they are used for OACensus.</p>
</div>
<div class="sect2">
<h3 id="_modelbase">ModelBase</h3>
<div class="paragraph">
<p>The <code>ModelBase</code> class provides common methods and fields shared by all database model classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">ModelBase</span><span class="tok-p">(</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Which scraper populated this information?&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">truncate_title</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">length</span><span class="tok-o">=</span><span class="tok-mi">40</span><span class="tok-p">):</span>
        <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">title</span>
        <span class="tok-k">if</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-p">)</span> <span class="tok-o">&lt;</span> <span class="tok-n">length</span><span class="tok-p">:</span>
            <span class="tok-k">if</span> <span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
                <span class="tok-k">return</span> <span class="tok-n">title</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-s">&quot;utf-8&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;ignore&quot;</span><span class="tok-p">)</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-k">return</span> <span class="tok-n">title</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-n">truncated</span> <span class="tok-o">=</span> <span class="tok-n">title</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">:</span><span class="tok-n">length</span><span class="tok-p">]</span>
            <span class="tok-k">if</span> <span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">truncated</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
                <span class="tok-n">truncated</span> <span class="tok-o">=</span> <span class="tok-n">truncated</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-s">&quot;utf-8&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;ignore&quot;</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-s">u&quot;{0}...&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">truncated</span><span class="tok-p">)</span>

    <span class="tok-k">class</span> <span class="tok-nc">Meta</span><span class="tok-p">:</span>
        <span class="tok-n">database</span> <span class="tok-o">=</span> <span class="tok-n">db</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">delete_all_from_source</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">delete</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">source</span> <span class="tok-o">==</span> <span class="tok-n">source</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">()</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">count_from_source</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">select</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">source</span> <span class="tok-o">==</span> <span class="tok-n">source</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">exist_records_from_source</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">count_from_source</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">count_from_source</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;TODO IMPLEMENT UNICODE FOR </span><span class="tok-si">%s</span><span class="tok-s">&quot;</span> <span class="tok-o">%</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">__class__</span><span class="tok-o">.</span><span class="tok-n">__name__</span>

    <span class="tok-k">def</span> <span class="tok-nf">__str__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">unicode</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">encode</span><span class="tok-p">(</span><span class="tok-s">&quot;ascii&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;ignore&quot;</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_article">Article</h3>
<div class="paragraph">
<p>The basic element we are interested in is the Article. The remaining models
exist to provide information about articles.</p>
</div>
<div class="paragraph">
<p>Here is the source code for the Article class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">Article</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Title of article.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">doi</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Digital object identifier for article.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">date_published</span> <span class="tok-o">=</span> <span class="tok-n">DateField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Date on which article was published.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">period</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Name of date-based period in which this article was scraped.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Web page for article information.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Journal</span><span class="tok-p">,</span> <span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Journal object for journal in which article was published.&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&#39;{0}&#39;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">truncate_title</span><span class="tok-p">())</span>

    <span class="tok-k">def</span> <span class="tok-nf">instance_for</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">repository_name</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Retrieves one of this article&#39;s instances, for the provided repository name.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-n">instances</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instances</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-n">Repository</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-n">Repository</span><span class="tok-o">.</span><span class="tok-n">name</span> <span class="tok-o">==</span> <span class="tok-n">repository_name</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">instances</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">instances</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">free_to_read_instances</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instances</span><span class="tok-o">.</span><span class="tok-n">select</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-n">Instance</span><span class="tok-o">.</span><span class="tok-n">free_to_read</span> <span class="tok-o">==</span> <span class="tok-bp">True</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">is_free_to_read</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span> <span class="tok-ow">or</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">free_to_read_instances</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>

    <span class="tok-k">def</span> <span class="tok-nf">instance_licenses</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-k">for</span> <span class="tok-n">instance</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instances</span> <span class="tok-k">if</span> <span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-o">!=</span> <span class="tok-bp">None</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-nf">licenses</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Return a list of all applicable licenses.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">()</span> <span class="tok-o">+</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance_licenses</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">has_license</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">())</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>

    <span class="tok-k">def</span> <span class="tok-nf">has_open_license</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">open_licenses</span> <span class="tok-o">=</span> <span class="tok-bp">None</span><span class="tok-p">):</span>
        <span class="tok-n">article_open_licenses</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">license</span> <span class="tok-k">for</span> <span class="tok-n">license</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">()</span>
                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">open_licenses</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">)</span> <span class="tok-ow">or</span> <span class="tok-p">(</span><span class="tok-n">license</span> <span class="tok-ow">in</span> <span class="tok-n">open_licenses</span><span class="tok-p">)]</span>
        <span class="tok-k">return</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">article_open_licenses</span><span class="tok-p">)</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">create_or_update_by_doi</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        If an article with DOI corresponding to the &#39;doi&#39; arg exists, update</span>
<span class="tok-sd">        its attributes using the remaining args. If not, create it.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">doi</span> <span class="tok-o">==</span> <span class="tok-n">args</span><span class="tok-p">[</span><span class="tok-s">&#39;doi&#39;</span><span class="tok-p">])</span>
            <span class="tok-k">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-ow">in</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">iteritems</span><span class="tok-p">():</span>
                <span class="tok-nb">setattr</span><span class="tok-p">(</span><span class="tok-n">article</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
            <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-k">except</span> <span class="tok-n">Article</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">Article</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">args</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">article</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_repository">Repository</h3>
<div class="paragraph">
<p>A repository is a place to "deposit" articles. This term is used loosely. It
may mean that an electronic copy of the article is available for download, or
it may simply mean that there&#8217;s some metadata available about the article.</p>
</div>
<div class="paragraph">
<p>The Repository class just represents these virtual locations, so it&#8217;s a simple
model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">Repository</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Descriptive name for the repository.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">info_url</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;For convenience, URL of info page for the repository.&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&#39;{0}&#39;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-p">)</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">create_or_update_by_name</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">name</span> <span class="tok-o">==</span> <span class="tok-n">args</span><span class="tok-p">[</span><span class="tok-s">&#39;name&#39;</span><span class="tok-p">])</span>
            <span class="tok-k">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-ow">in</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">iteritems</span><span class="tok-p">():</span>
                <span class="tok-nb">setattr</span><span class="tok-p">(</span><span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
            <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-k">except</span> <span class="tok-n">Repository</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">Repository</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">args</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">repo</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_instance">Instance</h3>
<div class="paragraph">
<p>When an article is "deposited" in a repository, we refer to this occurrence as
an "instance". The Instance class acts as a join table between the Article and
Repository models.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">Instance</span><span class="tok-p">(</span><span class="tok-n">OpenMetaCommon</span><span class="tok-p">):</span>
    <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Article</span><span class="tok-p">,</span> <span class="tok-n">related_name</span><span class="tok-o">=</span><span class="tok-s">&quot;instances&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">repository</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Repository</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Repository in which this instance is deposited or described.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">identifier</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Identifier within the repository.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">info_url</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;For convenience, URL of an info page for the article.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">download_url</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;URL for directly downloading the article. May be tested for status and file size.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">expected_file_size</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span> <span class="tok-o">=</span> <span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Expected file size if article is downloadable.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">expected_file_hash</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span> <span class="tok-o">=</span> <span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Expected file checksum if article is downloadable.&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;Instance &#39;{0}&#39; (id: {2}) in {1}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">truncate_title</span><span class="tok-p">(),</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">identifier</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Instance class is a subclass of OpenMetaCommon and so some fields and methods are defined there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">OpenMetaCommon</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-s">&quot;Common fields shared by Rating and Instance tables.&quot;</span>
    <span class="tok-n">free_to_read</span> <span class="tok-o">=</span> <span class="tok-n">BooleanField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Are journal contents available online for free?&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">license</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">License</span><span class="tok-p">,</span> <span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">start_date</span> <span class="tok-o">=</span> <span class="tok-n">DateField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;This rating&#39;s properties are in effect commencing from this date.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">end_date</span> <span class="tok-o">=</span> <span class="tok-n">DateField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;This rating&#39;s properties are in effect up to this date.&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">validate_downloadable</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Validate that the article is available at the designated URL and</span>
<span class="tok-sd">        corresponds to expected or min file size and expected file type, if</span>
<span class="tok-sd">        provided.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-s">&quot;not implemented&quot;</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_journal">Journal</h3>
<div class="paragraph">
<p>While the Instance relationship between articles and repositories is
many-to-many, there&#8217;s also a many-to-one relationship from articles to
journals. We assume that an article can be published in a single Journal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">Journal</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">index</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Name of journal.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Website of journal.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">publisher</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Publisher</span><span class="tok-p">,</span> <span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Publisher object corresponding to journal publisher.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">issn</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span> <span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;ISSN of journal.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">eissn</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Electronic ISSN (EISSN) of journal.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">doi</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;DOI for journal.&quot;</span><span class="tok-p">)</span>

    <span class="tok-n">subject</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Subject area which this journal deals with.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">country</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Country of publication for this journal.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">language</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Language(s) in which journal is published.&quot;</span><span class="tok-p">)</span>

    <span class="tok-n">iso_abbreviation</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">medline_ta</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">nlm_unique_id</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">issn_linking</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;Journal {0} [{1}]: {2}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">issn</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">truncate_title</span><span class="tok-p">())</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">create_or_update_by_issn</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-p">):</span>
        <span class="tok-n">issn</span> <span class="tok-o">=</span> <span class="tok-n">args</span><span class="tok-p">[</span><span class="tok-s">&#39;issn&#39;</span><span class="tok-p">]</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">issn</span> <span class="tok-o">==</span> <span class="tok-n">issn</span><span class="tok-p">)</span>
            <span class="tok-k">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-ow">in</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">iteritems</span><span class="tok-p">():</span>
                <span class="tok-k">if</span> <span class="tok-n">k</span> <span class="tok-o">!=</span> <span class="tok-s">&#39;source&#39;</span><span class="tok-p">:</span>
                    <span class="tok-nb">setattr</span><span class="tok-p">(</span><span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
            <span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-k">except</span> <span class="tok-n">Journal</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">Journal</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">args</span><span class="tok-p">)</span>

        <span class="tok-k">return</span> <span class="tok-n">journal</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">by_issn</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-p">,</span> <span class="tok-n">issn</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">issn</span> <span class="tok-o">==</span> <span class="tok-n">issn</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">Journal</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-k">pass</span>

    <span class="tok-k">def</span> <span class="tok-nf">is_free_to_read</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">on_date</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">):</span>
        <span class="tok-s">&quot;Is true if there is one Rating on the journal which indicates free-to-read.&quot;</span>
        <span class="tok-k">if</span> <span class="tok-n">on_date</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-s">&quot;date ranges not implemented yet&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-nb">any</span><span class="tok-p">(</span><span class="tok-n">rating</span><span class="tok-o">.</span><span class="tok-n">free_to_read</span> <span class="tok-k">for</span> <span class="tok-n">rating</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ratings</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">licenses</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">rating</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-k">for</span> <span class="tok-n">rating</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ratings</span> <span class="tok-k">if</span> <span class="tok-n">rating</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-o">!=</span> <span class="tok-bp">None</span><span class="tok-p">]</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rating">Rating</h3>
<div class="paragraph">
<p>Metadata about a Journal is stored in ratings. There may be multiple ratings
for a single Journal. Here&#8217;s the Rating class source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">Rating</span><span class="tok-p">(</span><span class="tok-n">OpenMetaCommon</span><span class="tok-p">):</span>
    <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Journal</span><span class="tok-p">,</span> <span class="tok-n">related_name</span><span class="tok-o">=</span><span class="tok-s">&quot;ratings&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;Rating {1} on {0}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">title</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some commonalities between a Rating and an Instance, so it also inherits from OpenMetaCommon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">OpenMetaCommon</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-s">&quot;Common fields shared by Rating and Instance tables.&quot;</span>
    <span class="tok-n">free_to_read</span> <span class="tok-o">=</span> <span class="tok-n">BooleanField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;Are journal contents available online for free?&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">license</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">License</span><span class="tok-p">,</span> <span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">start_date</span> <span class="tok-o">=</span> <span class="tok-n">DateField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;This rating&#39;s properties are in effect commencing from this date.&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">end_date</span> <span class="tok-o">=</span> <span class="tok-n">DateField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
            <span class="tok-n">help_text</span><span class="tok-o">=</span><span class="tok-s">&quot;This rating&#39;s properties are in effect up to this date.&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">validate_downloadable</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Validate that the article is available at the designated URL and</span>
<span class="tok-sd">        corresponds to expected or min file size and expected file type, if</span>
<span class="tok-sd">        provided.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-s">&quot;not implemented&quot;</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_publisher">Publisher</h3>
<div class="paragraph">
<p>A Journal belongs to a single Publisher:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">Publisher</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;Publisher {0}: {1}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-p">)</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">find_or_create_by_name</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">publisher</span> <span class="tok-o">=</span> <span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">cls</span><span class="tok-o">.</span><span class="tok-n">name</span> <span class="tok-o">==</span> <span class="tok-n">name</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">Publisher</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-n">publisher</span> <span class="tok-o">=</span> <span class="tok-n">Publisher</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-n">source</span><span class="tok-p">)</span>

        <span class="tok-k">return</span> <span class="tok-n">publisher</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_license">License</h3>
<div class="paragraph">
<p>Both Ratings and Instances can provide information about a License which pertains to an article or a journal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">License</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">alias</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">()</span>
    <span class="tok-n">title</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">()</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;License {0}: {1}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">alias</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">title</span><span class="tok-p">)</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">find_license</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-p">,</span> <span class="tok-n">alias</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">((</span><span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">alias</span> <span class="tok-o">==</span> <span class="tok-n">alias</span><span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-p">(</span><span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">url</span> <span class="tok-o">==</span> <span class="tok-n">alias</span><span class="tok-p">)</span> <span class="tok-o">|</span> <span class="tok-p">(</span><span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">title</span> <span class="tok-o">==</span> <span class="tok-n">alias</span><span class="tok-p">))</span>
        <span class="tok-k">except</span> <span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">LicenseAlias</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">LicenseAlias</span><span class="tok-o">.</span><span class="tok-n">alias</span> <span class="tok-o">==</span> <span class="tok-n">alias</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">license</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The LicenseAlias table stores alternate names for various licenses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">LicenseAlias</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">license</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">License</span><span class="tok-p">)</span>
    <span class="tok-n">alias</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">unique</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lists">Lists</h3>
<div class="paragraph">
<p>The JournalList and ArticleList classes, unsurprisingly, allow you to create lists of journals and articles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">JournalList</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journals</span><span class="tok-p">()),</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;Journal List {2} ({0}): {1}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__len__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">memberships</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">__getitem__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">memberships</span><span class="tok-p">[</span><span class="tok-n">key</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">journal</span>

    <span class="tok-k">def</span> <span class="tok-nf">add_journal</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-n">JournalListMembership</span><span class="tok-p">(</span>
            <span class="tok-n">journal_list</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-p">,</span>
            <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-n">source</span><span class="tok-p">,</span>
            <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">journal</span>
        <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">journals</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">membership</span><span class="tok-o">.</span><span class="tok-n">journal</span> <span class="tok-k">for</span> <span class="tok-n">membership</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">memberships</span><span class="tok-p">]</span>
</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">ArticleList</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">()</span>
    <span class="tok-n">orcid</span> <span class="tok-o">=</span> <span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__unicode__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">articles</span><span class="tok-p">()),</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">name</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-s">u&quot;&lt;Article List ({0} articles): {1}&gt;&quot;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">__len__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">memberships</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">__getitem__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">memberships</span><span class="tok-p">[</span><span class="tok-n">key</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">article</span>

    <span class="tok-k">def</span> <span class="tok-nf">add_article</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">article</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-n">ArticleListMembership</span><span class="tok-p">(</span>
            <span class="tok-n">article_list</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-p">,</span>
            <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-n">source</span><span class="tok-p">,</span>
            <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">article</span>
        <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">articles</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">membership</span><span class="tok-o">.</span><span class="tok-n">article</span> <span class="tok-k">for</span> <span class="tok-n">membership</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">memberships</span><span class="tok-p">]</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the join tables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">JournalListMembership</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">journal_list</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">JournalList</span><span class="tok-p">,</span> <span class="tok-n">related_name</span><span class="tok-o">=</span><span class="tok-s">&quot;memberships&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Journal</span><span class="tok-p">,</span> <span class="tok-n">related_name</span><span class="tok-o">=</span><span class="tok-s">&quot;memberships&quot;</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">ArticleListMembership</span><span class="tok-p">(</span><span class="tok-n">ModelBase</span><span class="tok-p">):</span>
    <span class="tok-n">article_list</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">ArticleList</span><span class="tok-p">,</span> <span class="tok-n">related_name</span><span class="tok-o">=</span><span class="tok-s">&quot;memberships&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">ForeignKeyField</span><span class="tok-p">(</span><span class="tok-n">Article</span><span class="tok-p">,</span> <span class="tok-n">related_name</span><span class="tok-o">=</span><span class="tok-s">&quot;memberships&quot;</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_is_it_open_access">Is It Open Access?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The point of all these database models is to enable us to ask the question "Is
it open access?". So, let&#8217;s explore how we will do that.</p>
</div>
<div class="paragraph">
<p>There are two different components to Open Access. Availability and license.
Availability asks "Is this article freely available for reading?". License asks
"What are the terms under which this article&#8217;s contents are licensed?" Once we
know the license, we then want to ask "Is this an open license?"</p>
</div>
<div class="paragraph">
<p>The question of free-to-read is simpler. Either there&#8217;s a link for obtaining the
article&#8217;s contents, or there&#8217;s not. The question of whether a license is "open"
is more fluid. There are different definitions of "open", and depending on the
context of your task, you might need to use a particular definition one day,
and a different definition the next.</p>
</div>
<div class="sect2">
<h3 id="_is_it_free_to_read">Is it Free to Read?</h3>
<div class="paragraph">
<p>Let&#8217;s first examine how we will answer the simpler question, "Is this article
Free to Read?" The article can be made freely available to read either by being
published in a journal which is free to read, or by being made freely available
through some other means. We will represent each of these "other means" as an
instance in a repository. For example, the repository might be an actual
institutional repository where the article is available for download.</p>
</div>
<div class="paragraph">
<p>So, the question "Is this article free to read?" can be rephrased as "Is this
article either in a free to read journal or a free to read instance in at least
one repository?" Or, in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">is_free_to_read</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span> <span class="tok-ow">or</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">free_to_read_instances</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>With:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">free_to_read_instances</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instances</span><span class="tok-o">.</span><span class="tok-n">select</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">where</span><span class="tok-p">(</span><span class="tok-n">Instance</span><span class="tok-o">.</span><span class="tok-n">free_to_read</span> <span class="tok-o">==</span> <span class="tok-bp">True</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>And:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">is_free_to_read</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">on_date</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">):</span>
        <span class="tok-s">&quot;Is true if there is one Rating on the journal which indicates free-to-read.&quot;</span>
        <span class="tok-k">if</span> <span class="tok-n">on_date</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-s">&quot;date ranges not implemented yet&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-nb">any</span><span class="tok-p">(</span><span class="tok-n">rating</span><span class="tok-o">.</span><span class="tok-n">free_to_read</span> <span class="tok-k">for</span> <span class="tok-n">rating</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ratings</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can verify in testing that <code>is_free_to_read</code> returns true if the journal is free to read:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">def</span> <span class="tok-nf">test_article_free_to_read_from_journal</span><span class="tok-p">():</span>
    <span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">create_journal_and_article</span><span class="tok-p">()</span>
    <span class="tok-n">rating</span> <span class="tok-o">=</span> <span class="tok-n">Rating</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">journal</span><span class="tok-o">=</span><span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">free_to_read</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-s">&quot;manual&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if there&#8217;s a free to read instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">def</span> <span class="tok-nf">test_article_free_to_read_from_repository</span><span class="tok-p">():</span>
    <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">create_journal_and_article</span><span class="tok-p">()</span>
    <span class="tok-n">repository</span> <span class="tok-o">=</span> <span class="tok-n">make_repo</span><span class="tok-p">()</span>
    <span class="tok-n">instance</span> <span class="tok-o">=</span> <span class="tok-n">Instance</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">article</span><span class="tok-o">=</span><span class="tok-n">article</span><span class="tok-p">,</span> <span class="tok-n">repository</span><span class="tok-o">=</span><span class="tok-n">repository</span><span class="tok-p">,</span>
            <span class="tok-n">free_to_read</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-s">&quot;manual&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">instance</span> <span class="tok-ow">in</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">instances</span>
    <span class="tok-k">assert</span> <span class="tok-ow">not</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>And not otherwise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">def</span> <span class="tok-nf">test_article_not_free_to_read</span><span class="tok-p">():</span>
    <span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">create_journal_and_article</span><span class="tok-p">()</span>
    <span class="tok-n">rating</span> <span class="tok-o">=</span> <span class="tok-n">Rating</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">journal</span><span class="tok-o">=</span><span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">free_to_read</span><span class="tok-o">=</span><span class="tok-bp">False</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-s">&quot;manual&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-ow">not</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span>
    <span class="tok-k">assert</span> <span class="tok-ow">not</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">is_free_to_read</span><span class="tok-p">()</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>free_to_read</code> attribute on a Rating or an Instance is determined by the
scrapers which obtain this data from various sources.</p>
</div>
<div class="paragraph">
<p>There&#8217;s also a <code>validate_downloadable</code> stub method which could be implemented
to allow users to test whether a provided URL is valid and the resulting file
appears to be the correct article file. Currently this does nothing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">validate_downloadable</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Validate that the article is available at the designated URL and</span>
<span class="tok-sd">        corresponds to expected or min file size and expected file type, if</span>
<span class="tok-sd">        provided.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-s">&quot;not implemented&quot;</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="icon-check-empty"></i> Journal free to read might need to accept dates - open a github issue and link from here.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_is_it_openly_licensed">Is it openly licensed?</h3>
<div class="paragraph">
<p>In order to determine if an article is openly licensed, we need to do two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify the applicable license.</p>
</li>
<li>
<p>Determine the openness of the license.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The license for an article may either be one which is applied to the Journal in
which the Article is published, or the license may be specified in an Instance
within a Repository.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the Journal class&#8217;s <code>licenses</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">licenses</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">rating</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-k">for</span> <span class="tok-n">rating</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ratings</span> <span class="tok-k">if</span> <span class="tok-n">rating</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-o">!=</span> <span class="tok-bp">None</span><span class="tok-p">]</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the Article class&#8217;s <code>instance_licenses</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">instance_licenses</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-k">for</span> <span class="tok-n">instance</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instances</span> <span class="tok-k">if</span> <span class="tok-n">instance</span><span class="tok-o">.</span><span class="tok-n">license</span> <span class="tok-o">!=</span> <span class="tok-bp">None</span><span class="tok-p">]</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s the Article class&#8217;s <code>licenses</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">licenses</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Return a list of all applicable licenses.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">()</span> <span class="tok-o">+</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">instance_licenses</span><span class="tok-p">()</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use this to implement a <code>has_license</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">has_license</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">())</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a <code>has_open_license</code> method, with the option to specify a list of licenses to be considered open:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">has_open_license</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">open_licenses</span> <span class="tok-o">=</span> <span class="tok-bp">None</span><span class="tok-p">):</span>
        <span class="tok-n">article_open_licenses</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">license</span> <span class="tok-k">for</span> <span class="tok-n">license</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">()</span>
                <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">open_licenses</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">)</span> <span class="tok-ow">or</span> <span class="tok-p">(</span><span class="tok-n">license</span> <span class="tok-ow">in</span> <span class="tok-n">open_licenses</span><span class="tok-p">)]</span>
        <span class="tok-k">return</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">article_open_licenses</span><span class="tok-p">)</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a test showing how adding licenses to a Journal Rating or an Article
Instance means they are both attached to the Article:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">def</span> <span class="tok-nf">test_article_licenses</span><span class="tok-p">():</span>
    <span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">article</span> <span class="tok-o">=</span> <span class="tok-n">create_journal_and_article</span><span class="tok-p">()</span>
    <span class="tok-n">repository</span> <span class="tok-o">=</span> <span class="tok-n">make_repo</span><span class="tok-p">()</span>

    <span class="tok-n">cc_by_license</span> <span class="tok-o">=</span> <span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">find_license</span><span class="tok-p">(</span><span class="tok-s">&quot;cc-by&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">cc_nc_license</span> <span class="tok-o">=</span> <span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">find_license</span><span class="tok-p">(</span><span class="tok-s">&quot;cc-by-nc&quot;</span><span class="tok-p">)</span>

    <span class="tok-n">rating</span> <span class="tok-o">=</span> <span class="tok-n">Rating</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">journal</span><span class="tok-o">=</span><span class="tok-n">journal</span><span class="tok-p">,</span> <span class="tok-n">license</span><span class="tok-o">=</span><span class="tok-n">cc_by_license</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-s">&quot;manual&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-p">[</span><span class="tok-n">cc_by_license</span><span class="tok-p">]</span>

    <span class="tok-n">instance</span> <span class="tok-o">=</span> <span class="tok-n">Instance</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">article</span><span class="tok-o">=</span><span class="tok-n">article</span><span class="tok-p">,</span> <span class="tok-n">repository</span><span class="tok-o">=</span><span class="tok-n">repository</span><span class="tok-p">,</span>
            <span class="tok-n">license</span><span class="tok-o">=</span><span class="tok-n">cc_nc_license</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-s">&quot;manual&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">licenses</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-p">[</span><span class="tok-n">cc_by_license</span><span class="tok-p">,</span> <span class="tok-n">cc_nc_license</span><span class="tok-p">]</span>

    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">has_license</span><span class="tok-p">()</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">has_open_license</span><span class="tok-p">()</span>
    <span class="tok-k">assert</span> <span class="tok-n">article</span><span class="tok-o">.</span><span class="tok-n">has_open_license</span><span class="tok-p">([</span><span class="tok-n">cc_by_license</span><span class="tok-p">])</span>
</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scraping_workflow">Scraping Workflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The scraping workflow needs to accomplish:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>obtaining raw data from remote data sources</p>
</li>
<li>
<p>parsing the raw data into normalized values</p>
</li>
<li>
<p>populating the database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Subsequent runs of the system should be able to add incremental new data or
selectively replace existing data which needs updating.</p>
</div>
<div class="paragraph">
<p>The scraping process is broken into two stages. In the first stage, remote data
is fetched and cached in a raw or mostly-raw state. In the second stage, the
cached data is parsed, processed and stored in the database. If data is already
cached locally, this step should not need to be repeated unless the cache
expires or is emptied by the user. Similarly, if the data is already in the
database (and the first stage data is cached), then the parsing should not need
to be repeated.</p>
</div>
<div class="paragraph">
<p>The <code>is_data_cached</code> method tells us if data has already been cached locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">is_data_cached</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">mtime</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">getmtime</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">cache_dir</span><span class="tok-p">())</span>
            <span class="tok-n">cache_expires</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;cache-expires&#39;</span><span class="tok-p">)</span>
            <span class="tok-k">if</span> <span class="tok-n">cache_expires</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
                <span class="tok-k">return</span> <span class="tok-bp">True</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">cache_last_modified</span> <span class="tok-o">=</span> <span class="tok-n">datetime</span><span class="tok-o">.</span><span class="tok-n">fromtimestamp</span><span class="tok-p">(</span><span class="tok-n">mtime</span><span class="tok-p">)</span>
                <span class="tok-n">units</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;cache-expires-units&#39;</span><span class="tok-p">)</span>
                <span class="tok-n">cache_delta</span> <span class="tok-o">=</span> <span class="tok-n">relativedelta_units</span><span class="tok-p">(</span><span class="tok-n">cache_expires</span><span class="tok-p">,</span> <span class="tok-n">units</span><span class="tok-p">)</span>
                <span class="tok-k">if</span> <span class="tok-n">cache_last_modified</span> <span class="tok-o">&lt;</span> <span class="tok-n">datetime</span><span class="tok-o">.</span><span class="tok-n">now</span><span class="tok-p">()</span> <span class="tok-o">-</span> <span class="tok-n">cache_delta</span><span class="tok-p">:</span>
                    <span class="tok-k">print</span> <span class="tok-s">&quot;clearing cache since content has expired&quot;</span>
                    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">remove_cache_dir</span><span class="tok-p">()</span>
                    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">remove_stored_data</span><span class="tok-p">()</span>
                    <span class="tok-k">return</span> <span class="tok-bp">False</span>
                <span class="tok-k">else</span><span class="tok-p">:</span>
                    <span class="tok-k">return</span> <span class="tok-bp">True</span>
        <span class="tok-k">except</span> <span class="tok-ne">OSError</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
            <span class="tok-k">if</span> <span class="tok-s">&quot;No such file or directory&quot;</span> <span class="tok-ow">in</span> <span class="tok-n">e</span><span class="tok-p">:</span>
                <span class="tok-k">return</span> <span class="tok-bp">False</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-k">raise</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the <code>is_data_stored</code> method tells us if the data is already in the
database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">is_data_stored</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">db_source</span><span class="tok-p">()</span>
        <span class="tok-k">return</span> <span class="tok-nb">any</span><span class="tok-p">(</span><span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">exist_records_from_source</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span> <span class="tok-k">for</span> <span class="tok-n">klass</span> <span class="tok-ow">in</span> <span class="tok-n">model_classes</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>We assume that the presence of any records generated by the active source means
that all data is stored. If there any any problems during scraping, then that
scraper should throw an exception. All exceptions are caught and all database
rows are removed prior to re-raising the exception.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the <code>run</code> method for the base <code>Scraper</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">cache_dir</span><span class="tok-p">())</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">is_data_cached</span><span class="tok-p">():</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-s">&quot;  scraped data is already cached&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-c"># Make sure database is cleared of old data.</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">remove_stored_data</span><span class="tok-p">()</span>
            <span class="tok-k">assert</span> <span class="tok-ow">not</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">is_data_stored</span><span class="tok-p">()</span>

            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reset_work_dir</span><span class="tok-p">()</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-s">&quot;  calling scrape method...&quot;</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">scrape</span><span class="tok-p">()</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">copy_work_dir_to_cache</span><span class="tok-p">()</span>

        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">is_data_stored</span><span class="tok-p">():</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-s">&quot;  data is already stored&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-s">&quot;  calling process method...&quot;</span><span class="tok-p">)</span>
            <span class="tok-k">try</span><span class="tok-p">:</span>
                <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">process</span><span class="tok-p">()</span>
            <span class="tok-k">except</span> <span class="tok-n">ArticleScraperException</span><span class="tok-p">:</span>
                <span class="tok-c"># don&#39;t need to clean up db here, it&#39;s already done in</span>
                <span class="tok-c"># ArticleScraper for the affected period</span>
                <span class="tok-k">raise</span>
            <span class="tok-k">except</span> <span class="tok-ne">Exception</span><span class="tok-p">:</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">remove_stored_data</span><span class="tok-p">()</span>
                <span class="tok-k">raise</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>run</code> method should not normally be overridden in a subclass.</p>
</div>
<div class="paragraph">
<p>For most scrapers, the cache directory is given a location based on a hash of
all the settings. If any settings change, the cache is invalidated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">hashcode</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">settings</span> <span class="tok-o">=</span> <span class="tok-bp">None</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Turn hash string into hash code.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">if</span> <span class="tok-n">settings</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-n">settings</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">hash_settings</span><span class="tok-p">()</span>
        <span class="tok-k">return</span> <span class="tok-n">hashlib</span><span class="tok-o">.</span><span class="tok-n">md5</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">hashstring</span><span class="tok-p">(</span><span class="tok-n">settings</span><span class="tok-p">))</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">()</span>
</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">hash_settings</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Dictionary of settings which should be used to construct hash.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">return</span> <span class="tok-nb">dict</span><span class="tok-p">((</span><span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
                <span class="tok-k">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting_values</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">iteritems</span><span class="tok-p">()</span>
                <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">k</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;no-hash-settings&#39;</span><span class="tok-p">))</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some scrapers have more fine-grained caching. The ArticleScraper caches data
for each period separately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">period_hash_settings</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">period_start_date</span><span class="tok-p">):</span>
        <span class="tok-n">settings</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">hash_settings</span><span class="tok-p">()</span>
        <span class="tok-n">settings</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">({</span><span class="tok-s">&#39;period&#39;</span> <span class="tok-p">:</span> <span class="tok-n">period_start_date</span><span class="tok-o">.</span><span class="tok-n">strftime</span><span class="tok-p">(</span><span class="tok-s">&quot;%Y-%m&quot;</span><span class="tok-p">)})</span>
        <span class="tok-k">return</span> <span class="tok-n">settings</span>
</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">period_hashcode</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">start_date</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">hashcode</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">period_hash_settings</span><span class="tok-p">(</span><span class="tok-n">start_date</span><span class="tok-p">))</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scrapers should implement the <code>scrape</code> and <code>process</code> methods to do all the work
needed in each step.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="icon-check-empty"></i> Test removing cache dirs for Scraper</p>
</li>
<li>
<p><i class="icon-check-empty"></i> Test removing cache dirs for Article Scraper</p>
</li>
<li>
<p><i class="icon-check-empty"></i> Test database methods for Article Scraper</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_scrapers_and_reports">Implementing Scrapers and Reports</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_plugins">Plugins</h3>
<div class="paragraph">
<p>Reports and Scrapers are examples of Cashew plugins. If you use an existing
scraper or report as your basis, you shouldn&#8217;t need to worry too much about how
plugins work, but you can read the Cashew docs for more information:</p>
</div>
<div class="paragraph">
<p><a href="http://dexy.github.io/cashew/">http://dexy.github.io/cashew/</a></p>
</div>
<div class="paragraph">
<p>One thing you need to do is add an import for any new modules you write to <code>load_plugins.py</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.biomedcentral</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.crossref</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.csvfile</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.demo</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.doaj</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.doilist</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.elsevier</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.licenses</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.oag</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.oai</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.orcids</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.pubmed</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.rcukgtr</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.scimago</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.scrapers.wiley</span>

<span class="tok-kn">import</span> <span class="tok-nn">oacensus.reports.excel_dump</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.reports.text_dump</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.reports.personal_openness</span>
<span class="tok-kn">import</span> <span class="tok-nn">oacensus.reports.institution</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t add an import, then the plugin won&#8217;t be registered and its alias
won&#8217;t be available when you run the <code>oacensus</code> command.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scraping">Scraping</h3>
<div class="paragraph">
<p>During the <code>scrape</code> stage, data files should be written to the scraper&#8217;s <code>work_dir()</code>, which is determined via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">work_dir</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_opts</span><span class="tok-p">[</span><span class="tok-s">&#39;workdir&#39;</span><span class="tok-p">],</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">hashcode</span><span class="tok-p">())</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the scraper has run successfully (without throwing exceptions) the
contents of the work_dir are copied to the cache_dir. Data should not be
written directly to the cache_dir, only the work_dir.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example from a Demo scraper of writing to the work dir:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">scrape</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">filepath</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">work_dir</span><span class="tok-p">(),</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;data-file&#39;</span><span class="tok-p">))</span>
        <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-s">&quot;foo bar baz&quot;</span>
        <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">filepath</span><span class="tok-p">,</span> <span class="tok-s">&#39;w&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parsing">Parsing</h3>
<div class="paragraph">
<p>During the <code>process</code> stage, data files should be read from the <code>cache_dir</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">cache_dir</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_opts</span><span class="tok-p">[</span><span class="tok-s">&#39;cachedir&#39;</span><span class="tok-p">],</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">hashcode</span><span class="tok-p">())</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>When creating new objects in the database, a <code>source</code> should always be
specified. The <code>db_source</code> method returns either the alias or the <code>source</code>
setting if a one has been specified, in case you have multiple versions of the
same scraper running.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="icon-check-empty"></i> test that multiple scrapers based on the same alias works</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of a <code>process</code> method which reads data from the cache dir and
generates database entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">process</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">filepath</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">cache_dir</span><span class="tok-p">(),</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;data-file&#39;</span><span class="tok-p">))</span>
        <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">filepath</span><span class="tok-p">,</span> <span class="tok-s">&#39;r&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">raw_data</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">()</span>
        <span class="tok-n">publisher_names</span> <span class="tok-o">=</span> <span class="tok-n">raw_data</span><span class="tok-o">.</span><span class="tok-n">split</span><span class="tok-p">()</span>
        <span class="tok-k">for</span> <span class="tok-n">name</span> <span class="tok-ow">in</span> <span class="tok-n">publisher_names</span><span class="tok-p">:</span>
            <span class="tok-n">Publisher</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">db_source</span><span class="tok-p">())</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reporting">Reporting</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python"><span class="tok-k">class</span> <span class="tok-nc">TextDump</span><span class="tok-p">(</span><span class="tok-n">Report</span><span class="tok-p">):</span>
    <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">    Dump all database models containing data to a text file.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>
    <span class="tok-n">aliases</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-s">&#39;textdump&#39;</span><span class="tok-p">]</span>
    <span class="tok-n">_settings</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
            <span class="tok-s">&#39;filename&#39;</span> <span class="tok-p">:</span> <span class="tok-p">(</span><span class="tok-s">&quot;Name of file to write dump to.&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;dump.txt&quot;</span><span class="tok-p">)</span>
            <span class="tok-p">}</span>

    <span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-s">&quot;&quot;</span>

        <span class="tok-k">for</span> <span class="tok-n">klass</span> <span class="tok-ow">in</span> <span class="tok-n">model_classes</span><span class="tok-p">:</span>
            <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">select</span><span class="tok-p">()</span>
            <span class="tok-k">if</span> <span class="tok-n">rows</span><span class="tok-o">.</span><span class="tok-n">count</span><span class="tok-p">()</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span><span class="tok-p">:</span>
                <span class="tok-n">first</span> <span class="tok-o">=</span> <span class="tok-n">rows</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span>
                <span class="tok-n">keys</span> <span class="tok-o">=</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-n">first</span><span class="tok-o">.</span><span class="tok-n">__dict__</span><span class="tok-p">[</span><span class="tok-s">&#39;_data&#39;</span><span class="tok-p">])</span>

                <span class="tok-c"># print class name</span>
                <span class="tok-n">data</span> <span class="tok-o">+=</span> <span class="tok-n">klass</span><span class="tok-o">.</span><span class="tok-n">__name__</span> <span class="tok-o">+</span> <span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span>

                <span class="tok-c"># print header row</span>
                <span class="tok-n">data</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;</span><span class="tok-se">\t</span><span class="tok-s">&quot;</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-n">keys</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span>

                <span class="tok-c"># print data</span>
                <span class="tok-n">data</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span>
                            <span class="tok-s">&quot;</span><span class="tok-se">\t</span><span class="tok-s">&quot;</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-nb">getattr</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">,</span> <span class="tok-n">key</span><span class="tok-p">))</span> <span class="tok-k">for</span> <span class="tok-n">key</span> <span class="tok-ow">in</span> <span class="tok-n">keys</span><span class="tok-p">)</span>
                            <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">rows</span>
                         <span class="tok-p">)</span>

                <span class="tok-c"># add some spacing before the next section</span>
                <span class="tok-n">data</span> <span class="tok-o">+=</span> <span class="tok-s">&quot;</span><span class="tok-se">\n\n</span><span class="tok-s">&quot;</span>

        <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;filename&#39;</span><span class="tok-p">),</span> <span class="tok-s">&#39;w&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">f</span><span class="tok-o">.</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running">Running</h3>
<div class="paragraph">
<p>To run oacensus, you first need to create a YAML configuration file. Here&#8217;s one called <code>test-demo.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="yaml language-yaml"><span class="tok-p-Indicator">-</span> <span class="tok-l-Scalar-Plain">demo</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you run the oacensus command with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">oacensus run --config <span class="tok-s2">&quot;test-demo.yaml&quot;</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>After running this command, you generate reports you want via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="bash language-bash">oacensus reports --reports <span class="tok-s2">&quot;textdump&quot;</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from running the command looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>running demo scraper
scraping completed in 0:00:02.148815
running report textdump
reports completed in 0:00:00.002377
</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>textdump</code> report generates a file named dump.txt, here&#8217;s what it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Publisher
id	name	source
1	foo	demo
2	bar	demo
3	baz	demo

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scraper_classes">Scraper Classes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_journalscraper">JournalScraper</h3>

</div>
<div class="sect2">
<h3 id="_articlescraper">ArticleScraper</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_implemented_scrapers">Implemented Scrapers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_biomed_central">BioMed Central</h3>
<div class="listingblock">
<div class="content">
<pre>Scrape journal names from BioMed Central, an open access journal publisher.

This scraper obtains journal names, urls and ISSNs from the BioMed Central
website.</pre>
</div>
</div>
<div class="paragraph">
<p>The BioMedCentral website contains a list of all the journals published by
BioMedCentral. We assume that these are all free to read, and that they are all
licensed as cc-by (this license is a setting which can be
changed).</p>
</div>
<div class="sect3">
<h4 id="_scraping_2">Scraping</h4>
<div class="paragraph">
<p>We need to scrape the website to obtain a list of Journal names and assign
ratings to the journals.</p>
</div>
<div class="paragraph">
<p>The first page we will parse, <a href="http://www.biomedcentral.com/journals">http://www.biomedcentral.com/journals</a>, contains a list of all
journals.</p>
</div>
<div class="paragraph">
<p>The <code>journal_list_iter</code> method yields each block of journal information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">journal_list_iter</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">soup</span><span class="tok-p">):</span>
        <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">        Parse the full page HTML and generate an iterator for the HTML elements</span>
<span class="tok-sd">        containing individual journal information.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-n">journal_ul</span> <span class="tok-o">=</span> <span class="tok-n">soup</span><span class="tok-o">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-s">&quot;ul&quot;</span><span class="tok-p">,</span> <span class="tok-n">class_</span><span class="tok-o">=</span><span class="tok-s">&quot;journals&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">for</span> <span class="tok-n">entry</span> <span class="tok-ow">in</span> <span class="tok-n">journal_ul</span><span class="tok-o">.</span><span class="tok-n">findAll</span><span class="tok-p">(</span><span class="tok-s">&#39;h3&#39;</span><span class="tok-p">):</span>
            <span class="tok-k">if</span> <span class="tok-s">&#39;class&#39;</span> <span class="tok-ow">in</span> <span class="tok-n">entry</span><span class="tok-o">.</span><span class="tok-n">attrs</span> <span class="tok-ow">and</span> <span class="tok-s">&#39;core-journal-heading&#39;</span> <span class="tok-ow">in</span> <span class="tok-n">entry</span><span class="tok-p">[</span><span class="tok-s">&#39;class&#39;</span><span class="tok-p">]:</span>
                <span class="tok-k">continue</span> <span class="tok-c"># not a real entry</span>

            <span class="tok-n">reached_archived_journals</span> <span class="tok-o">=</span> <span class="tok-bp">False</span>
            <span class="tok-k">for</span> <span class="tok-n">parent</span> <span class="tok-ow">in</span> <span class="tok-n">entry</span><span class="tok-o">.</span><span class="tok-n">parents</span><span class="tok-p">:</span>
                <span class="tok-k">if</span> <span class="tok-n">parent</span><span class="tok-o">.</span><span class="tok-n">attrs</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s">&#39;id&#39;</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-s">&quot;archived-journals&quot;</span><span class="tok-p">:</span>
                    <span class="tok-n">reached_archived_journals</span> <span class="tok-o">=</span> <span class="tok-bp">True</span>
                    <span class="tok-k">break</span>
            <span class="tok-k">if</span> <span class="tok-n">reached_archived_journals</span><span class="tok-p">:</span>
                <span class="tok-k">break</span>

            <span class="tok-c"># if we get this far, the entry is for a journal</span>
            <span class="tok-n">anchor</span> <span class="tok-o">=</span> <span class="tok-n">entry</span><span class="tok-o">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-s">&#39;a&#39;</span><span class="tok-p">)</span>
            <span class="tok-k">yield</span> <span class="tok-n">anchor</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll use this method a few times.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s our <code>scrape</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">scrape</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">limit</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;limit&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">filepath</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">work_dir</span><span class="tok-p">(),</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;data-file&#39;</span><span class="tok-p">))</span>

        <span class="tok-c"># download the list of journals</span>
        <span class="tok-n">urllib</span><span class="tok-o">.</span><span class="tok-n">urlretrieve</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;url&#39;</span><span class="tok-p">),</span> <span class="tok-n">filepath</span><span class="tok-p">)</span>

        <span class="tok-c"># create a BeautifulSoup HTML parser</span>
        <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">filepath</span><span class="tok-p">,</span> <span class="tok-s">&#39;rb&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">soup</span> <span class="tok-o">=</span> <span class="tok-n">BeautifulSoup</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>

        <span class="tok-c"># iterate over each journal listed</span>
        <span class="tok-k">for</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">anchor</span> <span class="tok-ow">in</span> <span class="tok-nb">enumerate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal_list_iter</span><span class="tok-p">(</span><span class="tok-n">soup</span><span class="tok-p">)):</span>
            <span class="tok-k">if</span> <span class="tok-n">limit</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span> <span class="tok-ow">and</span> <span class="tok-n">i</span> <span class="tok-o">&gt;=</span> <span class="tok-n">limit</span><span class="tok-p">:</span>
                <span class="tok-k">break</span>

            <span class="tok-c"># scrape individual journal info</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">scrape_journal</span><span class="tok-p">(</span><span class="tok-n">anchor</span><span class="tok-p">)</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each journal we find, we then need to scrape its individual data, and we
need to verify that we have found its ISSN:</p>
</div>
<div class="paragraph">
<p>The <code>scrape_journal</code> method does this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">scrape_journal</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">anchor</span><span class="tok-p">):</span>
        <span class="tok-n">journal_url</span> <span class="tok-o">=</span> <span class="tok-n">anchor</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s">&#39;href&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">journal_filename</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal_filename</span><span class="tok-p">(</span><span class="tok-n">journal_url</span><span class="tok-p">)</span>
        <span class="tok-n">journal_filepath</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">work_dir</span><span class="tok-p">(),</span> <span class="tok-n">journal_filename</span><span class="tok-p">)</span>

        <span class="tok-n">issn_found</span> <span class="tok-o">=</span> <span class="tok-bp">False</span>
        <span class="tok-n">n_attempts</span> <span class="tok-o">=</span> <span class="tok-mi">5</span>
        <span class="tok-k">for</span> <span class="tok-n">attempt</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">n_attempts</span><span class="tok-p">):</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-s">&quot;  fetching </span><span class="tok-si">%s</span><span class="tok-s"> attempt </span><span class="tok-si">%s</span><span class="tok-s">&quot;</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">journal_url</span><span class="tok-p">,</span> <span class="tok-n">attempt</span><span class="tok-p">))</span>

            <span class="tok-c"># download journal&#39;s individual info page</span>
            <span class="tok-n">urllib</span><span class="tok-o">.</span><span class="tok-n">urlretrieve</span><span class="tok-p">(</span><span class="tok-n">journal_url</span><span class="tok-p">,</span> <span class="tok-n">journal_filepath</span><span class="tok-p">)</span>

            <span class="tok-c"># look for issn</span>
            <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">journal_filepath</span><span class="tok-p">,</span> <span class="tok-s">&#39;rb&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
                <span class="tok-n">journal_soup</span> <span class="tok-o">=</span> <span class="tok-n">BeautifulSoup</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
                <span class="tok-n">issn_span_list</span> <span class="tok-o">=</span> <span class="tok-n">journal_soup</span><span class="tok-o">.</span><span class="tok-n">select</span><span class="tok-p">(</span><span class="tok-s">&quot;#issn&quot;</span><span class="tok-p">)</span>
                <span class="tok-k">if</span> <span class="tok-n">issn_span_list</span><span class="tok-p">:</span>
                    <span class="tok-n">issn_found</span> <span class="tok-o">=</span> <span class="tok-bp">True</span>
                    <span class="tok-k">break</span>

        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">issn_found</span> <span class="tok-ow">and</span> <span class="tok-ow">not</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;issns&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">has_key</span><span class="tok-p">(</span><span class="tok-n">journal_url</span><span class="tok-p">):</span>
            <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-s">&quot;Issn not found in </span><span class="tok-si">%s</span><span class="tok-s"> after </span><span class="tok-si">%s</span><span class="tok-s"> tries.&quot;</span>
            <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-n">msg</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">journal_url</span><span class="tok-p">,</span> <span class="tok-n">n_attempts</span><span class="tok-p">))</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to create a file-system-friendly and reproducible file name for each
journal we download, we take a hash of its URL. We&#8217;ll use this <code>journal_filename</code> method
in both the scraping and parsing phases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">journal_filename</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">url</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">hashlib</span><span class="tok-o">.</span><span class="tok-n">md5</span><span class="tok-p">(</span><span class="tok-n">url</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">()</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point we have scraped one page containing the list of all journals, and
also scraped each journal&#8217;s individual information page. All these files are in
the cache.</p>
</div>
</div>
<div class="sect3">
<h4 id="_parsing_2">Parsing</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="python language-python">    <span class="tok-k">def</span> <span class="tok-nf">process</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">license</span> <span class="tok-o">=</span> <span class="tok-n">License</span><span class="tok-o">.</span><span class="tok-n">find_license</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">setting</span><span class="tok-p">(</span><span class="tok-s">&#39;license&#39;</span><span class="tok-p">))</span>
        <span class="tok-n">publisher</span> <span class="tok-o">=</span> <span class="tok-n">Publisher</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;BioMedCentral&quot;</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">db_source</span><span class="tok-p">())</span>
        <span class="tok-n">biomed_list</span> <span class="tok-o">=</span> <span class="tok-n">JournalList</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s">&quot;BioMedCentral Journals&quot;</span><span class="tok-p">,</span>
                <span class="tok-n">source</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">db_source</span><span class="tok-p">())</span>

        <span class="tok-n">soup</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">load_list_of_journals</span><span class="tok-p">()</span>
        <span class="tok-k">for</span> <span class="tok-n">anchor</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal_list_iter</span><span class="tok-p">(</span><span class="tok-n">soup</span><span class="tok-p">):</span>
            <span class="tok-n">journal_url</span> <span class="tok-o">=</span> <span class="tok-n">anchor</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s">&#39;href&#39;</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">print_progress</span><span class="tok-p">(</span><span class="tok-s">&quot;  parsing </span><span class="tok-si">%s</span><span class="tok-s">&quot;</span> <span class="tok-o">%</span> <span class="tok-n">journal_url</span><span class="tok-p">)</span>
            <span class="tok-n">issn</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">journal_issn</span><span class="tok-p">(</span><span class="tok-n">journal_url</span><span class="tok-p">)</span>

            <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">issn</span><span class="tok-p">:</span>
                <span class="tok-k">continue</span>

            <span class="tok-c"># create journal</span>
            <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
                    <span class="tok-s">&#39;title&#39;</span> <span class="tok-p">:</span> <span class="tok-n">anchor</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-o">.</span><span class="tok-n">strip</span><span class="tok-p">(),</span>
                    <span class="tok-s">&#39;url&#39;</span> <span class="tok-p">:</span> <span class="tok-n">anchor</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s">&#39;href&#39;</span><span class="tok-p">),</span>
                    <span class="tok-s">&#39;publisher&#39;</span> <span class="tok-p">:</span> <span class="tok-n">publisher</span>
                    <span class="tok-p">}</span>
            <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">create_or_modify_journal</span><span class="tok-p">(</span><span class="tok-n">issn</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-p">,</span> <span class="tok-n">biomed_list</span><span class="tok-p">)</span>

            <span class="tok-c"># create rating</span>
            <span class="tok-n">Rating</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
                    <span class="tok-n">journal</span> <span class="tok-o">=</span> <span class="tok-n">journal</span><span class="tok-p">,</span>
                    <span class="tok-n">free_to_read</span> <span class="tok-o">=</span> <span class="tok-bp">True</span><span class="tok-p">,</span>
                    <span class="tok-n">license</span> <span class="tok-o">=</span> <span class="tok-n">license</span><span class="tok-p">,</span>
                    <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">db_source</span><span class="tok-p">()</span>
                    <span class="tok-p">)</span>

        <span class="tok-k">return</span> <span class="tok-n">biomed_list</span>
</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-05-13 19:54:08 UTC
</div>
</div>
</body>
</html>